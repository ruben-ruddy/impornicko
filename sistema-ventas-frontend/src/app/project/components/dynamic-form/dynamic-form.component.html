<!-- // Dynamic Form Component Template -->
<form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6 p-4 bg-white rounded-xl ">
  @for (field of fields; track field.key || $index) {
    
    <!-- Título -->
    @if (field.type === 'title') {
      <h3 class="text-xl font-semibold mb-4 text-gray-800">{{ field.text }}</h3>
    }

    <!-- Campos en columnas -->
    @if (field.type === 'column') {
      <div [ngClass]="{
        'grid grid-cols-1 gap-6': field.columns.length === 1,
        'grid grid-cols-1 md:grid-cols-2 gap-6': field.columns.length > 1
      }">
        @for (column of field.columns; track $index) {
          <div class="space-y-4">
            @for (f of column.fields; track f.key || $index) {
              @if (isFieldVisible(f)) {
                <div class="flex flex-col">
                  <label class="text-gray-700 font-medium mb-1">{{ f.label }}</label>

                  <!-- Input -->
                  @if (['text', 'number'].includes(f.type)) {
                    <input [type]="f.type" [formControlName]="f.key" [readonly]="f.readonly"
                      class="input input-bordered w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-black" />
                  }

                  <!-- Select -->
                  @if (f.type === 'select') {
                    <select [formControlName]="f.key"
                      class="select bg-gray select-bordered w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                      @for (opt of f.options; track opt.value) {
                        <option [value]="opt.value">{{ opt.label }}</option>
                      }
                    </select>
                  }

                  <!-- Radio -->
                  @if (f.type === 'radio') {
                    <div class="flex flex-col space-y-2">
                      @for (opt of f.options; track opt.value) {
                        <label class="inline-flex items-center">
                          <input type="radio" [value]="opt.value" [formControlName]="f.key" class="form-radio text-blue-600" />
                          <span class="ml-2">{{ opt.label }}</span>
                        </label>
                      }
                    </div>
                  }

                  <!-- Date -->
                  @if (f.type === 'datetime') {
                    <input type="date" [formControlName]="f.key"
                      class="input input-bordered w-full px-3 py-2 border border-gray-300 rounded-md" />
                  }

                  <!-- File-->
                  @if (f.type === 'file') {
                    <div class="w-full">
                      <!-- Dropzone / Card input -->
                      <div
                        class="relative border-2 border-dashed border-gray-500 rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-blue-500 transition duration-300"
                        (click)="triggerFileInput(f.key)">
                        <svg class="w-10 h-10 text-black mb-2" fill="none" stroke="currentColor" stroke-width="2"
                          viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round"
                            d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v6m0 0l3-3m-3 3l-3-3M16 8a4 4 0 10-8 0v4" />
                        </svg>
                        <p class="text-black font-semibold">Haga clic para cargar o arrastre y suelte</p>
                        <p class="text-xs text-black mt-1">SVG, PNG, JPG o JPEG (MÁX. 2MB)</p>
                      </div>

                      <input type="file" class="hidden"  [attr.accept]="f.validators?.fileType?.join(',')"
                        (change)="onFileChange($event, f.key)" [attr.id]="'fileInput_' + f.key" />
                        
                      <!-- Error de validación -->
                      <div *ngIf="fileErrors[f.key]" class="text-red-500 text-sm mt-1">
                        {{ fileErrors[f.key] }}
                      </div>
                      
                      <!-- Preview -->
                      @if(f.key && previewFiles[f.key]){
                        <div class="mt-3 rounded-md overflow-hidden border border-gray-200">
                          <img *ngIf="isImage(previewFiles[f.key] ?? '')" [src]="previewFiles[f.key]" alt="Preview"
                            class="w-full object-contain max-h-60" />
                        </div>
                      }

                      @if(f.key){
                        <div class="text-center">
                          <img [src]="initialData[f.key]" alt="Imagen cargada" class="w-64 h-64 object-cover mx-auto">
                          {{initialData[f.key]}}
                        </div>
                      }
                    </div>
                  }

                  <!-- Validation Errors -->
                  <div class="text-red-500 text-sm mt-1" *ngIf="getControl(f.key)?.touched && getControl(f.key)?.invalid">
                    <div *ngIf="getControl(f.key)?.errors?.['required']">Este campo es obligatorio.</div>
                    <div *ngIf="getControl(f.key)?.errors?.['email']">Formato de correo inválido.</div>
                    <div *ngIf="getControl(f.key)?.errors?.['pattern']">Formato inválido.</div>
                    <div *ngIf="getControl(f.key)?.errors?.['minlength']">Mínimo {{ f.validators?.minLength }} caracteres.</div>
                    <div *ngIf="getControl(f.key)?.errors?.['maxlength']">Máximo {{ f.validators?.maxLength }} caracteres.</div>
                    <div *ngIf="getControl(f.key)?.errors?.['fileType']">Tipo de archivo no permitido.</div>
                    <div *ngIf="getControl(f.key)?.errors?.['fileSize']">Archivo demasiado grande.</div>
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>
    }

    <!-- Campos de tipo array -->
@else if (field.type === 'array') {
  <div class="array-field-container border border-gray-200 rounded-lg p-6 bg-gray-50">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">{{ field.label }}</h3>
    
    <div formArrayName="{{field.key}}">
      @for (item of getFormArray(field.key).controls; track $index; let i = $index) {
        <div [formGroupName]="i" class="array-item border border-gray-300 rounded-md p-4 mb-4 bg-white">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            @for (itemField of field.itemFields; track itemField.key || $index) {
              <div class="form-field">
                <label class="text-gray-700 font-medium mb-1 block">
                  {{ itemField.label }}
                  @if (itemField.validators?.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                
                <!-- Select para productos -->
                @if (itemField.type === 'select') {
                  <select 
                    [formControlName]="itemField.key"
                    (change)="onProductChange(field.key, i, itemField.key)"
                    class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleccionar {{itemField.label}}</option>
                    @for (option of itemField.options; track option.value) {
                      <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                }
                
                <!-- Input number para cantidades y precios -->
                @else if (itemField.type === 'number' && !itemField.readonly) {
                  <input 
                    [type]="itemField.type" 
                    [formControlName]="itemField.key"
                    [step]="itemField.step || '1'"
                    (input)="convertToNumber($event, field.key, i, itemField.key)"
                    class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                }
                
                <!-- Campo de solo lectura para subtotal -->
                @else if (itemField.readonly) {
                  <input 
                    [type]="itemField.type" 
                    [formControlName]="itemField.key"
                    [readonly]="true"
                    class="w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                }
                
                <!-- Input text para otros campos -->
                @else {
                  <input 
                    [type]="itemField.type" 
                    [formControlName]="itemField.key"
                    class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                }
                
                <!-- Validation Errors -->
                @if (getFormArray(field.key).at(i).get(itemField.key)?.touched && 
                     getFormArray(field.key).at(i).get(itemField.key)?.invalid) {
                  <div class="text-red-500 text-sm mt-1">
                    @if (getFormArray(field.key).at(i).get(itemField.key)?.errors?.['required']) {
                      <div>Este campo es obligatorio.</div>
                    }
                    @if (getFormArray(field.key).at(i).get(itemField.key)?.errors?.['min']) {
                      <div>El valor mínimo es {{ itemField.validators?.min }}.</div>
                    }
                  </div>
                }
              </div>
            }
          </div>
          
          <!-- Botón para eliminar item -->
          @if (getFormArray(field.key).length > 1) {
            <button 
              type="button" 
              (click)="removeArrayItem(field.key, i)"
              class="mt-4 bg-red-500 hover:bg-red-600 text-black px-3 py-1 rounded-md text-sm transition duration-300">
              {{ field.removeButtonText || 'Eliminar' }}
            </button>
          }
        </div>
      }
    </div>
    
    <!-- Botón para agregar nuevo item -->
    <button 
      type="button" 
      (click)="addArrayItem(field)"
      class="bg-blue-500  hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300">
        
      {{ field.addButtonText || 'Agregar' }}
    </button>
  </div>
}

    <!-- Campos individuales (no en columnas) -->
    @else if (field.key && field.type !== 'title' && field.type !== 'array') {
      @if (isFieldVisible(field)) {
        <div class="flex flex-col">
          <label class="text-gray-700 font-medium mb-1">{{ field.label }}</label>

          <!-- Input -->
          @if (['text', 'number'].includes(field.type)) {
            <input [type]="field.type" [formControlName]="field.key" [readonly]="field.readonly"
              class="input input-bordered w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          }

          <!-- Select -->
          @if (field.type === 'select') {
            <select [formControlName]="field.key"
              class="select bg-gray select-bordered w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              @for (opt of field.options; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
          }

          <!-- Validation Errors -->
          <div class="text-red-500 text-sm mt-1" *ngIf="getControl(field.key)?.touched && getControl(field.key)?.invalid">
            <div *ngIf="getControl(field.key)?.errors?.['required']">Este campo es obligatorio.</div>
            <div *ngIf="getControl(field.key)?.errors?.['email']">Formato de correo inválido.</div>
            <div *ngIf="getControl(field.key)?.errors?.['pattern']">Formato inválido.</div>
            <div *ngIf="getControl(field.key)?.errors?.['minlength']">Mínimo {{ field.validators?.minLength }} caracteres.</div>
            <div *ngIf="getControl(field.key)?.errors?.['maxlength']">Máximo {{ field.validators?.maxLength }} caracteres.</div>
          </div>
        </div>
      }
    }
  }
</form>